name: "ğŸš€ Code Quality & Testing"

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

jobs:
  quality-check:
    name: "ğŸ” Quality Assurance"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: "ğŸ¯ Ruff Linting & Formatting"
        run: |
          echo "ğŸ” Running Ruff lint check..."
          ruff check . --diff
          echo "ğŸ¨ Running Ruff format check..."
          ruff format . --check --diff

      - name: "ğŸ” MyPy Type Checking"
        run: |
          echo "ğŸ“Š Running MyPy type analysis..."
          mypy . --config-file=pyproject.toml

      - name: "ğŸ›¡ï¸ Bandit Security Analysis"
        run: |
          echo "ğŸ”’ Running Bandit security scan..."
          bandit -c pyproject.toml -r . -f json -o bandit-report.json
          bandit -c pyproject.toml -r . # Human readable output

      - name: "ğŸ§ª Pytest with Coverage"
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          pytest -v --cov=src --cov=main --cov-report=xml --cov-report=term --junitxml=test-results.xml

      - name: "ğŸ“Š Upload Coverage to Codecov"
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: "ğŸ“‹ Upload Test Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results.xml
            coverage.xml
            bandit-report.json
          retention-days: 30

  # SonarQube Analysis (Optional - Standalone Mode)
  # SonarQube for IDE Ã§alÄ±ÅŸÄ±yor standalone modda, CI'da ayrÄ± analiz gerekmez
  # EÄŸer merkezi SonarQube sunucusu kurulursa bu job aktive edilebilir

  pre-commit-check:
    name: "âš¡ Pre-commit Hooks"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: "âš¡ Run Pre-commit Hooks"
        run: |
          pre-commit run --all-files --show-diff-on-failure
